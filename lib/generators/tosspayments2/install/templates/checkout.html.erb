<h1>결제 진행</h1>

<div class="payment-info">
  <h3>결제 정보</h3>
  <p><strong>주문번호:</strong> <%= @payment.order_id %></p>
  <p><strong>결제금액:</strong> <%= @payment.formatted_amount %></p>
</div>

<!-- TossPayments 결제 위젯 영역 -->
<div id="payment-methods"></div>
<div id="agreement"></div>
<button id="payment-button" class="btn btn-primary">결제하기</button>

<%= tosspayments_script_tag %>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  // TossPayments 설정
  const clientKey = '<%= Rails.application.credentials.dig(:tosspayments, :client_key) || ENV["TOSSPAYMENTS_CLIENT_KEY"] %>';
  const customerKey = 'customer_<%= Time.current.to_i %>'; // 구매자 식별값
  
  if (!clientKey) {
    console.error('TossPayments 클라이언트 키가 설정되지 않았습니다.');
    alert('결제 서비스를 초기화할 수 없습니다. 관리자에게 문의하세요.');
    return;
  }

  try {
    // TossPayments 위젯 초기화
    const tosspayments = TossPayments(clientKey);
    const widgets = tosspayments.widgets({ customerKey: customerKey });

    // 결제 수단 렌더링
    await widgets.renderPaymentMethods({
      selector: '#payment-methods',
      variantKey: 'DEFAULT'
    });

    // 약관 동의 렌더링
    await widgets.renderAgreement({
      selector: '#agreement'
    });

    // 결제 버튼 이벤트 리스너
    document.getElementById('payment-button').addEventListener('click', async () => {
      try {
        await widgets.requestPayment({
          orderId: '<%= @payment.order_id %>',
          orderName: '결제 테스트 상품',
          customerName: '고객',
          amount: <%= @payment.amount %>,
          successUrl: '<%= success_payments_url %>',
          failUrl: '<%= fail_payments_url %>'
        });
      } catch (error) {
        console.error('결제 요청 실패:', error);
        alert('결제 요청에 실패했습니다: ' + (error.message || error.toString()));
      }
    });
  } catch (error) {
    console.error('TossPayments 초기화 실패:', error);
    alert('결제 서비스 초기화에 실패했습니다: ' + (error.message || error.toString()));
  }
});
</script>

<style>
  .payment-info {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 0.25rem;
    margin-bottom: 2rem;
  }
  
  #payment-methods {
    margin-bottom: 1rem;
  }
  
  #agreement {
    margin-bottom: 1rem;
  }
  
  #payment-button {
    width: 100%;
    padding: 0.75rem;
    font-size: 1.1rem;
    font-weight: bold;
  }
  
  .btn { 
    display: inline-block; 
    padding: 0.375rem 0.75rem; 
    margin-bottom: 0; 
    font-size: 1rem; 
    font-weight: 400; 
    line-height: 1.5; 
    text-align: center; 
    text-decoration: none; 
    vertical-align: middle; 
    cursor: pointer; 
    border: 1px solid transparent; 
    border-radius: 0.25rem; 
  }
  
  .btn-primary { 
    color: #fff; 
    background-color: #007bff; 
    border-color: #007bff; 
  }
  
  .btn-primary:hover {
    background-color: #0056b3;
    border-color: #004085;
  }
</style>